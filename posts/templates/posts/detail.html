{% extends 'base.html' %}

{% load static %}
{% block style %}
<link rel="stylesheet" href="{% static 'style/posts/detail.css' %}">
{% endblock style %}

{% block content %}
  <main>
    <section class="post-content">
      <div class="mb-5">
        {% if post.image %}
        <img src="{{ post.image.url }}" class="post-img" alt="Ïó¨ÌñâÏù¥ÎØ∏ÏßÄ">
        {% else %}
        <img src="{% static 'img/noimage.jpg' %}" class="post-img" alt="Ïù¥ÎØ∏ÏßÄÏóÜÏùå">
        {% endif %}
      </div>

      <header class="title-text mb-2">{{ post.title }}</header>
      <article class="d-flex text-nowrap">
        <p class="duration">
          <i class="bi bi-clock-history mark-text">{{ post.start_date }} ~ {{ post.end_date }}</i>
        </p>
        <p class="place">
          <i class="bi bi-geo-alt mark-text">{{ post.region }}</i>
        </p>
        <p>
          <i class="bi bi-star-fill"><span class="mark-text">{{ post.rating }}</span></i>
          <i class="bi bi-heart-fill"><span class="mark-text">{{ post.like_users.count }}</span></i>
        </p>
      </article>
      <article>
        <div class="flex-container">
          <div class="content-container">
            <div>{{ post.content|linebreaksbr }}</div>
            </div>
          <div class="user-profile-container">
            <div class="user-info d-flex">
              {% comment %} <a  href="{% url 'accounts:profile' post.user %}"> {% endcomment %}
                {% if post.user.profile_image %}
                <img src="{{ post.user.profile_image }}" alt="ÏÇ¨Ïö©ÏûêÌîÑÎ°úÌïÑÏù¥ÎØ∏ÏßÄ" />
                {% else %}
                <img src="{% static 'img/user_profile.png' %}" alt="Í∏∞Î≥∏ÌîÑÎ°úÌïÑÏù¥ÎØ∏ÏßÄ" />
                {% endif %}
                <div class="ms-2">
                  <div class='username-text'>{{ post.user }}</div>
                  <div class='userMbit-text'>{{ post.user.mbti }}</div>
                </div>
              {% comment %} </a> {% endcomment %}
            </div>
            <div class="user-follow">
              <button value="ÌåîÎ°úÏö∞">ÌåîÎ°úÏö∞</button>
            </div>
          </div>
        </div>
        
        <hr class="partition-line">
        <div class="position-relative map-detail">
          <div id="map" class="map-detail" data-place="{{ post.place }}"></div>
          <button onclick="panToDetail()" class="position-absolute z-3 fs-3 bg-white rounded-circle pin shadow-lg">
            <i class="bi bi-pin-map-fill"></i>
          </button>
        </div>
        <p class="post-place-text">{{ post.place }}</p>
      </article>
    </section>
    
    <div class ='content-info'>
      <span>{{ post.updated_at }}</span>
      <span class="content-fun"><a href="{% url 'posts:update' post.pk %}">ÏàòÏ†ï</a></span>
      <span class="content-fun"><a onclick="return confirm('Í≤åÏãúÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')" href="{% url 'posts:delete' post.pk %}">ÏÇ≠Ï†ú</a></span>
    </div>
      <hr class="partition-line">
    <section class="comments">
      <div class="border-bottom d-flex">
        <span class="mb-3">ÎåìÍ∏Ä {{ comments|length }}</span>
      </div>
      <table id="comment-list" class="table">
        <tbody>
          {% for comment in comments %}
            <tr id="comments" {% if request.user == comment.user %}class="bg-body-tertiary"{% endif %}>
              <td class="position-relative">
                <div class="d-flex justify-content-between">
                  <div class="d-flex align-items-start gap-2">
                    <!-- ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ -->
                    <div class="border rounded-circle position-relative mt-1 profile-img-sm">
                      {% if comment.user.image %}
                      <a href="{% url 'accounts:profile' comment.user.username %}">
                        <img src="{{ comment.user.image.url }}" alt="{{ comment.user }}" class="rounded-circle profile-img-sm">
                      </a>
                      {% else %}
                      <a href="{% url 'accounts:profile' comment.user.username %}">
                        <div class="position-absolute top-50 start-50 translate-middle">
                          <img src="{% static 'img/user_profile.png' %}" class="profile-img-sm" alt="Í∏∞Î≥∏ÌîÑÎ°úÌïÑÏù¥ÎØ∏ÏßÄ" />
                        </div>
                      </a>
                      {% endif %}
                    </div>
                    <!-- ÏûëÏÑ±Ïûê / ÎÇ¥Ïö© -->
                    <div>
                      <a href="{% url 'accounts:profile' comment.user.username %}">
                        <span>{{ comment.user }}</span>
                      </a>
                      <p class="m-0">{{ comment.content }}</p>
                      <p class="post-created text-secondary mt-2 mb-0">{{ post.created_at|date:'Y. m. d.  H:i' }}</p>
                    </div>
                  </div>
                  <!-- ÏÇ≠Ï†ú Î≤ÑÌäº -->
                  <div class="text-secondary">
                    {% if comment.user == request.user %}
                    <form action="{% url 'posts:comment_delete' post.pk comment.pk %}" method="POST">
                      {% csrf_token %}
                      <button  class="bg-transparent border-0 text-danger comment-delete" type="submit">
                        <div id="comment_delete" class="hidden"><i class="bi bi-x"></i></div>
                      </button>
                    </form>
                    {% endif %}
                  </div>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      
      <form id="comment-form" action="{% url 'posts:comment_create' post.pk  %}" method="POST">
        {% csrf_token %}
        <div id="comment-area" class="border rounded-3 p-3">
          <div class="d-flex justify-content-between">
            <span class="mb-2">{{ user.username }}</span>
            <div class="text-body-tertiary">
              <span id="comment-count"></span>
            </div>
          </div>
          {% for field in comment_form %}
            {{ field }}
          {% endfor %}
          <div class="text-end text-body-tertiary">
            <button id="comment-submit" type="submit" class="border-0 bg-transparent text-body-tertiary">Îì±Î°ù</button>
          </div>
        </div>
      </form>
    </section>
  </main>

  <!-- Ïù∏Ï†ë Í≤åÏãúÎ¨º -->
  <section class="box">
    <div id="container-posts">
      {% for adj_post in posts %}
      <div class="post-item">
        <a href="{% url 'posts:detail' adj_post.pk %}" class="card{% if post.pk == adj_post.pk %} card-active{% endif %}">
          {% if adj_post.image %}
          <img src="{{ adj_post.image.url }}" alt="Ïó¨ÌñâÏÇ¨ÏßÑ" class="card-img-top" />
          {% else %}
          <img
            src="{% static 'img/noimage.jpg' %}"
            alt="Ïù¥ÎØ∏ÏßÄÏóÜÏùå"
            class="card-img-top noimage-img"
          />
          {% endif %}
          <form action="{% url 'posts:post_likes' adj_post.pk %}" method="POST">
            {% csrf_token %}
            {% if request.user in adj_post.like_posts.all %}
            <input class='like-user' type="submit" value="ü§ç">
            {% else %}
            <input class='like-user' type="submit" value="‚ù§">
            {% endif %}
          </form>


          <div class="card-body">
            <div class="card-user">
              <p>
                {% if adj_post.user.profile_image %}
                <img
                  class="user-profile"
                  src="{{ post.user.profile_image }}"
                  alt="ÏÇ¨Ïö©ÏûêÌîÑÎ°úÌïÑÏù¥ÎØ∏ÏßÄ"
                />
                {% else %}
                <img
                class="user-profile"
                src="{% static 'img/user_profile.png' %}"
                alt="Í∏∞Î≥∏ÌîÑÎ°úÌïÑÏù¥ÎØ∏ÏßÄ"
                />
              </p>
                {% endif %}
              <span class="username">{{adj_post.user.username}}</span>
            </div>
            <h6 class="card-title">{{ adj_post.title }}</h6>
          </div>
        </a>
      </div>
      {% endfor %}
    </div>
  </section>

{% endblock content %}

{% block javascript %}
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=46fed7723052d8712b267e8a83ab2fa4&libraries=services"></script>
<script src="{% static 'js/map.js' %}"></script>
<script src="{% static 'js/comments.js' %}"></script>
{% comment %} <script>
  const commentForm = document.getElementById('comment-form')
  commentForm.addEventListener('submit', (event) => {
    event.preventDefault()
    const postPk = {{ post.pk }}
    const text = document.getElementById('id_content').value
    const xhr = new XMLHttpRequest()
    xhr.open('GET', `/posts/${postPk}/comment/`, true)
    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4 && xhr.status === 200) {
        const comment = JSON.parse(xhr.responseText).comment
        const commentList = document.getElementById('comment-list')
        const commentItem = document.createElement('div')
        commentItem.innerHTML = `
          <p>${comment.text}</p>
          <p>${comment.user}</p>
          <p>${comment.created_at}</p>
        `
        commentList.appendChild(commentItem)
        document.getElementById('id_text').value = ''
      }
    }
    xhr.send(null)
  })
  // 
  const addComment = () => {
    const postPk = {{ post.pk }}  // Í≤åÏãúÎ¨º pk Í∞ÄÏ†∏Ïò§Í∏∞
    const commentForm2 = document.querySelector('#comment-form');
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;  // CSRF ÌÜ†ÌÅ∞ Í∞ÄÏ†∏Ïò§Í∏∞
    const formData = new FormData(commentForm2);  // Ìèº Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
  
    // AJAX ÏöîÏ≤≠ Î≥¥ÎÇ¥Í∏∞
    fetch(`/posts/${postPk}/comment/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
      },
      body: formData,
    })
    .then(response => response.json())
    .then(data => {
      console.log(data);  // ÏÑúÎ≤ÑÎ°úÎ∂ÄÌÑ∞ Î∞õÏùÄ Îç∞Ïù¥ÌÑ∞ Ï∂úÎ†•
  
      // ÎåìÍ∏Ä Î™©Î°ù Í∞±Ïã†
      updateComments();
    })
    .catch(error => console.error(error));
  };
  
  // ÎåìÍ∏Ä Î™©Î°ùÏùÑ Í∞±Ïã†ÌïòÎäî Ìï®Ïàò
  const updateComments = () => {
    const postPk = {{ post.pk }}  // Í≤åÏãúÎ¨º pk Í∞ÄÏ†∏Ïò§Í∏∞
  
    // AJAX ÏöîÏ≤≠ Î≥¥ÎÇ¥Í∏∞
    fetch(`/posts/${postPk}/comment/list/`)
    .then(response => response.text())
    .then(data => {
      console.log(data);  // ÏÑúÎ≤ÑÎ°úÎ∂ÄÌÑ∞ Î∞õÏùÄ Îç∞Ïù¥ÌÑ∞ Ï∂úÎ†•
  
      // ÎåìÍ∏Ä Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
      const commentList = document.querySelector('#comment-list');
      commentList.innerHTML = data;
    })
    .catch(error => console.error(error));
  };
  
  // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
  const commentForm2 = document.querySelector('#comment-form');
  commentForm2.addEventListener('submit', event => {
    event.preventDefault();
    addComment();
  });
</script> {% endcomment %}
{% endblock javascript %}